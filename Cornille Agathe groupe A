#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <string.h>
#include <math.h> // Pour racine carrée dans la vérification des nombres premiers

int main() {
    int C = 1;
    int a, b, d, somme, multiplication, soustraction, reponse, compteur = 0;
    int i, table, j, resultat, r, score_initial = 0;
    int essais;
    char nom[50], ligne[200];
    FILE *fichier;

    // Etape 14-15 : Gestion des scores - chargement
    printf("Entrez votre nom : ");
    scanf("%s", nom);

    fichier = fopen("scores.txt", "r");
    if (fichier != NULL) {
        int trouvé = 0;
        while (fgets(ligne, sizeof(ligne), fichier)) {
            if (strstr(ligne, nom)) {
                sscanf(ligne, "Nom : %*s | Score : %d", &score_initial);
                compteur = score_initial;
                trouvé = 1;
                printf("Bienvenue %s, votre dernier score est : %d\n", nom, compteur);
                break;
            }
        }
        fclose(fichier);
        if (!trouvé) {
            printf("Aucun score précédent trouvé pour %s. Nouveau joueur !\n", nom);
        }
    } else {
        printf("Fichier des scores introuvable. Création à la sauvegarde.\n");
    }

    // Boucle principale du jeu
    while (C != 0) {
        // Etape 1 : Afficher le menu
        printf("+--------------------------------------+\n");
        printf("| 1 : Addition                         |\n");
        printf("| 2 : Soustraction                     |\n");
        printf("| 3 : Multiplication                   |\n");
        printf("| 4 : Tables des multiplications       |\n");
        printf("| 5 : Divisions                        |\n");
        printf("| 6 : Complément à 10                  |\n");
        printf("| 7 : Double d'un nombre               |\n");
        printf("| 8 : Moitié d'un nombre pair          |\n");
        printf("| 9 : Suite numérique                  |\n");
        printf("| 10 : Pair ou impair                  |\n");
        printf("| 11 : Nombre premier ou non           |\n");
        printf("| 0 : Sortir du jeu                    |\n");
        printf("+--------------------------------------+\n");

        // Etape 2 : Demander le choix du joueur
        printf("Quel est votre choix ? ");
        scanf("%d", &C);

        srand(time(NULL)); // Initialiser la génération aléatoire

        if (C == 1) { // Etape 4 : Addition
            a = rand() % 101; // 0-100
            b = rand() % 101;
            somme = a + b;

            for (essais = 1; essais <= 3; essais++) {
                printf("Essai %d - Combien fait %d + %d ? ", essais, a, b);
                scanf("%d", &reponse);
                if (reponse == somme) {
                    printf("Bonne réponse !\n");
                    compteur += 4 - essais;
                    break;
                } else if (essais < 3) {
                    printf("Incorrect, essaye encore.\n");
                } else {
                    printf("Raté ! La bonne réponse était : %d\n", somme);
                }
            }
        }

        if (C == 2) { // Etape 10 : Soustraction
            a = rand() % 101;
            b = rand() % 101;
            if (a < b) { d = a; a = b; b = d; } // Permutation pour avoir a >= b
            soustraction = a - b;

            for (essais = 1; essais <= 3; essais++) {
                printf("Essai %d - Combien fait %d - %d ? ", essais, a, b);
                scanf("%d", &reponse);
                if (reponse == soustraction) {
                    printf("Bonne réponse !\n");
                    compteur += 4 - essais;
                    break;
                } else if (essais < 3) {
                    printf("Incorrect, essaye encore.\n");
                } else {
                    printf("Raté ! La bonne réponse était : %d\n", soustraction);
                }
            }
        }

        if (C == 3) { // Etape 9 : Multiplication 
            a = rand() % 10 + 1; // Nombre entre 1 et 10
            b = rand() % 10 + 1; // Nombre entre 1 et 10
            multiplication = a * b;

            for (essais = 1; essais <= 3; essais++) {
                printf("Essai %d - Combien fait %d * %d ? ", essais, a, b);
                scanf("%d", &reponse);

                if (reponse == multiplication) {
                    printf("Bonne réponse !\n");
                    compteur += 4 - essais; // 3 points si bon au 1er essai, 2 au 2e, 1 au 3e
                    break;
                } else if (essais < 3) {
                    printf("Incorrect, essaye encore.\n");
                } else {
                    printf("Raté ! La bonne réponse était : %d\n", multiplication);
                }
            }
        }

        if (C == 4) { // Etape 12-13 : Tables de multiplication
            printf("Sur quelle table voulez-vous travailler (1 à 10) ? ");
            scanf("%d", &table);
            for (i = 1; i <= 10; i++) {
                printf("%d x %d = %d\n", table, i, table * i);
            }
            for (j = 1; j <= 10; j++) {
                resultat = table * j;
                for (essais = 1; essais <= 3; essais++) {
                    printf("Essai %d - Combien fait %d x %d ? ", essais, table, j);
                    scanf("%d", &r);
                    if (r == resultat) {
                        printf("Bonne réponse !\n");
                        compteur += 4 - essais;
                        break;
                    } else if (essais < 3) {
                        printf("Incorrect, essaye encore.\n");
                    } else {
                        printf("Raté ! La bonne réponse était : %d\n", resultat);
                    }
                }
            }
        }

        if (C == 5) { // Division 
            printf("Désolé, ce jeu n'est pas encore disponible.\n");
        }

        // ------------------- ÉTAPE 18 ---------------------
        if (C == 6) { // Complément à 10
            a = rand() % 10;
            int complement = 10 - a;
            for (essais = 1; essais <= 3; essais++) {
                printf("Essai %d - Complément à 10 de %d ? ", essais, a);
                scanf("%d", &reponse);
                if (reponse == complement) {
                    printf("Bonne réponse !\n");
                    compteur += 4 - essais;
                    break;
                } else if (essais < 3) {
                    printf("Incorrect, essaye encore.\n");
                } else {
                    printf("Raté ! La bonne réponse était : %d\n", complement);
                }
            }
        }

        if (C == 7) { // Double d'un nombre
            a = rand() % 51;
            int double_val = 2 * a;
            for (essais = 1; essais <= 3; essais++) {
                printf("Essai %d - Double de %d ? ", essais, a);
                scanf("%d", &reponse);
                if (reponse == double_val) {
                    printf("Bonne réponse !\n");
                    compteur += 4 - essais;
                    break;
                } else if (essais < 3) {
                    printf("Incorrect, essaye encore.\n");
                } else {
                    printf("Raté ! La bonne réponse était : %d\n", double_val);
                }
            }
        }

        if (C == 8) { // Moitié d'un nombre
            a = (rand() % 50) * 2;
            int moitie = a / 2;
            for (essais = 1; essais <= 3; essais++) {
                printf("Essai %d - Moitié de %d ? ", essais, a);
                scanf("%d", &reponse);
                if (reponse == moitie) {
                    printf("Bonne réponse !\n");
                    compteur += 4 - essais;
                    break;
                } else if (essais < 3) {
                    printf("Incorrect, essaye encore.\n");
                } else {
                    printf("Raté ! La bonne réponse était : %d\n", moitie);
                }
            }
        }

        if (C == 9) { // Suite numérique
            int depart = rand() % 50;
            int pas = (rand() % 5) + 1;
            int suivant = depart + pas;
            printf("Suite : %d, %d, ... Quel est le prochain nombre ? ", depart, suivant);
            scanf("%d", &reponse);
            if (reponse == suivant + pas) {
                printf("Bonne réponse !\n");
                compteur += 3;
            } else {
                printf("Raté ! La bonne réponse était : %d\n", suivant + pas);
            }
        }
        // ------------------- ÉTAPE 19 ---------------------

        if (C == 10) { // Pair ou impair
            a = rand() % 100;
            printf("Le nombre est : %d\n", a);
            printf("Tape 1 pour pair, 2 pour impair : ");
            scanf("%d", &reponse);
            if ((a % 2 == 0 && reponse == 1) || (a % 2 != 0 && reponse == 2)) {
                printf("Bonne réponse !\n");
                compteur += 3;
            } else {
                printf("Mauvaise réponse !\n");
            }
        }

        if (C == 11) { // Nombre premier ou non
            a = rand() % 100;
            int premier = 1;
            if (a < 2) premier = 0;
            for (int div = 2; div <= sqrt(a); div++) {
                if (a % div == 0) {
                    premier = 0;
                    break;
                }
            }
            printf("Le nombre est : %d\n", a);
            printf("Tape 1 pour premier, 2 pour non premier : ");
            scanf("%d", &reponse);
            if ((premier && reponse == 1) || (!premier && reponse == 2)) {
                printf("Bonne réponse !\n");
                compteur += 3;
            } else {
                printf("Mauvaise réponse !\n");
            }
        }

        printf("Votre score actuel est : %d\n", compteur);
    }

    // Etape 16 : Sauvegarde du score à la fin
    if (compteur != score_initial) {
        fichier = fopen("scores.txt", "a");
        if (fichier != NULL) {
            time_t t;
            time(&t);
            fprintf(fichier, "Nom : %s | Score : %d | Date : %s", nom, compteur, ctime(&t));
            fclose(fichier);
            printf("Score mis à jour !\n");
        } else {
            printf("Erreur de sauvegarde.\n");
        }
    } else {
        printf("Aucune mise à jour du score.\n");
    }

    printf("Merci d'avoir joué ! À bientôt !\n");
    return 0;
}

